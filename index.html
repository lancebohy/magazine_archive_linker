<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C&VG Magazine Archive Index</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background-color: #09090b; 
            color: #fafafa; 
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
        
        .loading-text::after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        .issue-card {
            background-color: #111113;
            border: 1px solid #27272a;
            transition: all 0.2s ease;
        }
        .issue-card:hover {
            border-color: #3f3f46;
            background-color: #18181b;
        }
    </style>
</head>
<body class="min-h-screen font-sans antialiased">

    <div class="max-w-5xl mx-auto p-6 md:p-12">
        <header class="mb-12 border-b border-zinc-800 pb-8 flex flex-col md:flex-row md:items-end justify-between gap-6">
            <div>
                <h1 class="text-4xl font-black text-white tracking-tighter uppercase italic">C&VG Archive Index</h1>
                <p class="text-zinc-500 mt-2 font-medium">Computer & Video Games Magazine • 1981—2004</p>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3">
                <input 
                    type="text" 
                    id="searchBox" 
                    placeholder="Search issues (e.g. 093b)..." 
                    class="hidden bg-zinc-900 border border-zinc-800 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600 transition-all text-sm w-full sm:w-64"
                >
                <button id="scanBtn" class="bg-red-700 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-lg transition-all flex items-center justify-center gap-2 active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    Initialize Scanner
                </button>
            </div>
        </header>

        <div id="statusArea" class="hidden mb-8 bg-zinc-900 text-zinc-300 px-5 py-4 rounded-xl border border-zinc-800 flex items-center justify-between">
            <span id="statusText" class="loading-text font-mono text-xs uppercase tracking-widest text-red-500">Accessing Metadata API</span>
            <div id="loader" class="animate-spin rounded-full h-4 w-4 border-2 border-red-600 border-t-transparent"></div>
        </div>

        <div id="missingReport" class="hidden mb-8 p-6 bg-red-950/20 border border-red-900/50 rounded-xl">
            <h2 id="missingHeading" class="text-red-500 text-xs font-black uppercase tracking-[0.2em] mb-3">Gap Analysis</h2>
            <div id="missingList" class="text-red-400 font-mono text-xs flex flex-wrap gap-2"></div>
        </div>

        <div id="resultsContainer" class="hidden space-y-3">
            <div class="grid grid-cols-12 gap-4 px-4 py-2 text-[10px] font-black text-zinc-600 uppercase tracking-[0.2em]">
                <div class="col-span-8 md:col-span-10">Magazine Issue</div>
                <div class="col-span-4 md:col-span-2 text-right">Primary Source</div>
            </div>
            <div id="issueList" class="space-y-3"></div>
        </div>
        
        <div id="emptyState" class="py-4">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-12">
                <div class="md:col-span-3 space-y-8">
                    <div>
                        <h2 class="text-2xl font-black text-white uppercase tracking-tight mb-4">Operator Manual</h2>
                        <p class="text-zinc-400 leading-relaxed max-w-prose text-sm">
                            This application is a live metadata aggregator for the <span class="text-white">C&VG Digital Archive</span>. It is designed to audit thousands of files across the Internet Archive to help collectors identify missing issues and find high-quality PDF copies.
                        </p>
                    </div>

                    <div class="space-y-6">
                        <div class="flex gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-zinc-800 border border-zinc-700 flex items-center justify-center text-xs font-bold text-zinc-100">1</div>
                            <div>
                                <h4 class="text-sm font-bold text-zinc-200 uppercase tracking-wide">Initialize Scan</h4>
                                <p class="text-xs text-zinc-500 mt-1">Click the red button above to ping the Internet Archive API. This now searches for all naming variations including C+VG and C&VG.</p>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-zinc-800 border border-zinc-700 flex items-center justify-center text-xs font-bold text-zinc-100">2</div>
                            <div>
                                <h4 class="text-sm font-bold text-zinc-200 uppercase tracking-wide">Gap Analysis</h4>
                                <p class="text-xs text-zinc-500 mt-1">Once the scan completes, a red panel will appear showing exactly how many issues are missing from the known sequence.</p>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-zinc-800 border border-zinc-700 flex items-center justify-center text-xs font-bold text-zinc-100">3</div>
                            <div>
                                <h4 class="text-sm font-bold text-zinc-200 uppercase tracking-wide">Verify & Download</h4>
                                <p class="text-xs text-zinc-500 mt-1">Use the "Verify Source" button on any entry to check the real-time file size and unlock the direct PDF download link.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <div class="bg-zinc-900/50 border border-zinc-800 p-6 rounded-2xl">
                        <h3 class="text-xs font-black text-zinc-500 uppercase tracking-widest mb-4">Quick Technical Specs</h3>
                        <ul class="space-y-3">
                            <li class="flex justify-between text-[11px] border-b border-zinc-800 pb-2">
                                <span class="text-zinc-500">Source API</span>
                                <span class="text-zinc-300 font-mono">Archive.org v1</span>
                            </li>
                            <li class="flex justify-between text-[11px] border-b border-zinc-800 pb-2">
                                <span class="text-zinc-500">Target Range</span>
                                <span class="text-zinc-300 font-mono">Issue 001 - 277</span>
                            </li>
                            <li class="flex justify-between text-[11px] border-b border-zinc-800 pb-2">
                                <span class="text-zinc-500">Scan Depth</span>
                                <span class="text-zinc-300 font-mono">3000 Records</span>
                            </li>
                            <li class="flex justify-between text-[11px]">
                                <span class="text-zinc-500">Verification</span>
                                <span class="text-zinc-300 font-mono">Direct PDF Only</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const scanBtn = document.getElementById('scanBtn');
        const statusArea = document.getElementById('statusArea');
        const statusText = document.getElementById('statusText');
        const issueList = document.getElementById('issueList');
        const resultsContainer = document.getElementById('resultsContainer');
        const emptyState = document.getElementById('emptyState');
        const searchBox = document.getElementById('searchBox');
        const missingReport = document.getElementById('missingReport');
        const missingList = document.getElementById('missingList');
        const missingHeading = document.getElementById('missingHeading');

        let allGroupedIssues = [];

        scanBtn.addEventListener('click', startScan);
        searchBox.addEventListener('input', (e) => renderList(e.target.value));

        function formatDate(dateString) {
            if (!dateString) return 'Unknown Date';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            } catch (e) {
                return 'Invalid Date';
            }
        }

        async function fetchWithRetry(url, retries = 5, backoff = 1000) {
            try {
                const response = await fetch(url);
                if (response.status === 429 || response.status >= 500) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, backoff));
                        return fetchWithRetry(url, retries - 1, backoff * 2);
                    }
                }
                return await response.json();
            } catch (err) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, backoff));
                    return fetchWithRetry(url, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        async function startScan() {
            scanBtn.disabled = true;
            statusArea.classList.remove('hidden');
            emptyState.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            missingReport.classList.add('hidden');
            
            try {
                statusText.innerText = "Initiating Multi-Variation Archive Scan";
                
                const queryParts = [
                    'title:("Computer and Video Games" OR "Computer & Video Games" OR "C+VG" OR "C&VG" OR "CandVG")',
                    'mediatype:(texts)'
                ];
                const query = queryParts.join(' AND ');
                const searchUrl = `https://archive.org/advancedsearch.php?q=${encodeURIComponent(query)}&fl[]=identifier,title,downloads,publicdate&rows=3000&output=json`;

                const data = await fetchWithRetry(searchUrl);
                const docs = data.response.docs || [];

                const issueMap = new Map();
                const issueRegex = /(?:Issue\s*|#\s*|CVG\s*(?:Issue\s*)?|No\.\s*|Vol\.\s*|0+|(?:\s|^))(\d{1,3})([a-zA-Z]{0,1})(?:\s|\.|$|:|_)/i;

                docs.forEach(doc => {
                    const title = doc.title || "";
                    if (/Video\s*Games\s*(&|and)\s*Computer/i.test(title)) return; 

                    const match = title.match(issueRegex);
                    if (match) {
                        const number = match[1];
                        const suffix = match[2] ? match[2].toLowerCase() : "";
                        const numVal = parseInt(number);
                        
                        if (numVal > 0 && numVal <= 400) {
                            const key = `${number.padStart(3, '0')}${suffix}`;
                            if (!issueMap.has(key)) issueMap.set(key, []);
                            issueMap.get(key).push({
                                id: doc.identifier,
                                rawTitle: title,
                                downloads: doc.downloads || 0,
                                publicDate: doc.publicdate
                            });
                        }
                    }
                });

                allGroupedIssues = Array.from(issueMap.keys()).map(key => ({
                    key,
                    items: issueMap.get(key).sort((a, b) => b.downloads - a.downloads)
                })).sort((a, b) => a.key.localeCompare(b.key));

                const targetCount = 277;
                const foundNumbers = new Set(allGroupedIssues.map(g => parseInt(g.key)));
                const missing = [];
                for (let i = 1; i <= targetCount; i++) {
                    if (!foundNumbers.has(i)) {
                        missing.push(i.toString().padStart(3, '0'));
                    }
                }

                if (missing.length > 0) {
                    missingHeading.innerText = `Gap Analysis: ${missing.length} Issues Missing (Target: 277)`;
                    missingList.innerHTML = missing.map(n => `<span class="bg-red-900/40 px-2 py-0.5 rounded">#${n}</span>`).join('');
                    missingReport.classList.remove('hidden');
                } else {
                    missingHeading.innerText = `Archive Complete (277/277)`;
                    missingReport.classList.remove('hidden');
                }

                statusArea.classList.add('hidden');
                searchBox.classList.remove('hidden');
                scanBtn.innerHTML = "Update Catalog";
                scanBtn.disabled = false;
                renderList();

            } catch (error) {
                statusText.innerText = "API Busy: Retrying connection...";
                setTimeout(() => startScan(), 5000);
            }
        }

        async function verifyLink(identifier, elementId) {
            const btn = document.getElementById(elementId);
            btn.innerHTML = `<span class="animate-pulse">...</span>`;
            btn.disabled = true;

            try {
                const metaUrl = `https://archive.org/metadata/${identifier}/files`;
                const data = await fetchWithRetry(metaUrl);
                const files = data.result || [];
                const pdfFile = files.find(f => 
                    f.name.toLowerCase().endsWith('.pdf') && 
                    !f.name.toLowerCase().includes('_archive.pdf') &&
                    !f.name.toLowerCase().includes('_text.pdf')
                ) || files.find(f => f.name.toLowerCase().endsWith('.pdf'));

                if (pdfFile) {
                    const finalUrl = `https://archive.org/download/${identifier}/${pdfFile.name}`;
                    const size = pdfFile.size ? (pdfFile.size / (1024 * 1024)).toFixed(1) + ' MB' : 'Link';
                    btn.outerHTML = `<a href="${finalUrl}" target="_blank" class="bg-blue-600 text-white px-4 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest hover:bg-blue-500 transition-all shadow-lg">${size}</a>`;
                } else {
                    btn.innerText = "NO PDF";
                }
            } catch (e) {
                btn.innerText = "RETRY";
                btn.disabled = false;
            }
        }

        function renderList(filter = "") {
            issueList.innerHTML = "";
            const lowerFilter = filter.toLowerCase();
            const filtered = allGroupedIssues.filter(group => group.key.includes(lowerFilter));

            filtered.forEach(group => {
                const row = document.createElement('div');
                row.className = "issue-card p-5 rounded-xl flex flex-col gap-4";
                
                const sourcesHtml = group.items.map((item, idx) => {
                    const subId = `v-${item.id}-${idx}`;
                    const displayDate = formatDate(item.publicDate);
                    return `
                    <div class="flex items-center justify-between p-3 bg-black/30 rounded-lg border border-zinc-800/50">
                        <div class="flex flex-col truncate mr-4">
                            <span class="text-zinc-400 text-[11px] truncate mb-0.5">${item.rawTitle}</span>
                            <span class="text-zinc-600 text-[9px] font-mono uppercase tracking-widest">
                                IA: ${item.id} • ${displayDate} • ${item.downloads.toLocaleString()} DLs
                            </span>
                        </div>
                        <button id="${subId}" onclick="verifyLink('${item.id}', '${subId}')" class="shrink-0 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 px-3 py-1.5 text-[9px] font-black rounded uppercase tracking-widest border border-zinc-700">Verify Source</button>
                    </div>`;
                }).join('');

                row.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-zinc-100 font-black text-lg uppercase italic tracking-tighter">Issue #${group.key}</h3>
                        <div class="text-[10px] text-zinc-600 font-mono">${group.items.length} Match${group.items.length > 1 ? 'es' : ''}</div>
                    </div>
                    <div class="space-y-2">${sourcesHtml}</div>`;
                issueList.appendChild(row);
            });
        }
    </script>
</body>
</html>
